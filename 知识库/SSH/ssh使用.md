### SSH是什么

简单说，SSH是一种网络协议，用于计算机之间的加密登录。如果一个用户从本地计算机，使用SSH协议登录另一台远程计算机，我们就可以认为，这种登录是安全的，即使被中途截获，密码也不会泄露。最早的时候，互联网通信都是明文通信，一旦被截获，内容就暴露无疑。1995年，芬兰学者Tatu Ylonen设计了SSH协议，将登录信息全部加密，成为互联网安全的一个基本解决方案，迅速在全世界获得推广，目前已经成为Linux系统的标准配置。

SSH只是一种协议，存在多种实现，既有商业实现，也有开源实现。本文针对的实现是OpenSSH，它是自由软件，应用非常广泛。这里只讨论SSH在Linux Shell中的用法。如果要在Windows系统中使用SSH，会用到另一种软件PuTTY，这需要另文介绍。
中间人攻击

SSH之所以能够保证安全，原因在于它采用了公钥加密。

整个过程是这样的：（1）远程主机收到用户的登录请求，把自己的公钥发给用户。（2）用户使用这个公钥，将登录密码加密后，发送回来。（3）远程主机用自己的私钥，解密登录密码，如果密码正确，就同意用户登录。

这个过程本身是安全的，但是实施的时候存在一个风险：如果有人截获了登录请求，然后冒充远程主机，将伪造的公钥发给用户，那么用户很难辨别真伪。因为不像https协议，SSH协议的公钥是没有证书中心（CA）公证的，也就是说，都是自己签发的。
可以设想，如果攻击者插在用户与远程主机之间（比如在公共的wifi区域），用伪造的公钥，获取用户的登录密码。再用这个密码登录远程主机，那么SSH的安全机制就荡然无存了。这种风险就是著名的"中间人攻击"（Man-in-the-middle attack）。

### SSH的安装


1. SSH分为客户端 openssh-client 和服务器 openssh-server，可以利用以下命令确认电脑上是否安装了客户端和服务器。

```zsh
dpkg -l | grep ssh
```

2. 如果只是想远程登陆别的机器只需要安装客户端（Ubuntu默认安装了客户端），如果要开放本机的SSH服务就需要安装服务器。
```zsh
sudo apt-get install openssh-client 
sudo apt-get install openssh-server 
```

3. 启动服务器的SSH服务:首先确认ssh-server是否已经启动了


```zsh
ps -e | grep ssh
```

`sshd` 表示ssh-server已经启动了。如果没有启动，可以使用如下命令启动：

```zsh
sudo /etc/init.d/ssh start 
```

停止和重启ssh服务的命令如下：

```zsh
sudo /etc/init.d/ssh stop  #server停止ssh服务 
sudo /etc/init.d/ssh restart  #server重启ssh服务
```


### OpenSSH

程序主要包括了几个部分：

ssh：SSH 客户端实现
scp, sftp：rcp的替代方案，将文件复制到其他电脑上
sshd：SSH 服务端实现
ssh-keygen：产生 RSA 或 ECDSA 密钥，用来认证
ssh-agent, ssh-add：帮助用户不需要每次输入密钥或密码的工具
ssh-keysacn：收集大量主机的 ssh 主机公钥


### 基于密码的登录连接

输入一下命令，请求连接远程服务器，输入密码后连接成功。

```zsh
# ssh连接默认端口是22，如果本地机用户名和远程机用户名一致，可以省略用户名
ssh username@host
# 也可以指定连接端口
ssh -p port user@host
```

### 基于公钥登录连接

前面的命令是通过密码（私钥）登录，这样比较麻烦，因为每次登录我们都需要输入密码，因此我们可以选择 SSH 的公钥登录连接方式，省去输入密码的步骤。

公钥登录的原理，是先在本地机器上生成一对公钥和私钥，然后手动把公钥上传到远程服务器。这样每次登录时，远程主机会向用户发送一段随机字符串，而用户会用自己的私钥对这段随机字符串进行加密，然后把加密后的字符串发送给远程主机，远程主机会用用户的公钥对这段字符串进行解密，如果解密后的字符串和远程主机发送的随机字符串一致，那么就认为用户是合法的，允许登录。

只需要把私钥传给远程服务器，远程服务器就可以验证私钥是否是对应的公钥，如果是就允许登录，这样就不需要输入密码了。

SSH 支持多种用于身份验证密钥的公钥算法, 包括 RSA、DSA、ECDSA 和 ED25519 等，其中 RSA 算法是最常用的，因为它是 SSH 协议的默认算法，所以我们这里以 RSA 算法为例来生成密钥，并配置免密码远程连接。


1. 使用ssh-keygen命令生成密钥对：

```zsh
ssh-keygen -t rsa   #-t表示类型选项，这里采用rsa加密算法
```

2. 用ssh-copy-id将公钥复制到远程机器中, ssh-copy-id会将公钥写到远程主机的 ~/.ssh/authorized_key 文件中

```zsh
ssh-copy-id -i .ssh/id_rsa.pub  username@host
```

经过以上两个步骤后，登录这个远程主机就不用再输入密码了。


### 清除know_hosts缓存

有时候对某个网站的密钥进行修改后，需要清除原来的密钥缓存，使用以下命令来清除存储在`know_hosts`中的对某一具体`ip`的密钥缓存。

```zsh
ssh-keygen -R 52.74.223.119
```